# TBLASTX ä¸¦åˆ—åŒ–è¨ˆç”»æ›¸

**ä½œæˆæ—¥**: 2026-01-06  
**ç›®çš„**: TBLASTXå‡¦ç†ã®ä¸¦åˆ—åŒ–ã«ã‚ˆã‚Šæ€§èƒ½å‘ä¸Šã‚’å›³ã‚Šã¤ã¤ã€NCBI BLAST+ã¨ã®å‡ºåŠ›å®Œå…¨ä¸€è‡´ã‚’ç¶­æŒ  
**NCBI codebase**: `/mnt/c/Users/genom/GitHub/ncbi-blast/`

---

## 1. ç¾çŠ¶åˆ†æ

### 1.1 æ—¢ã«ä¸¦åˆ—åŒ–ã•ã‚Œã¦ã„ã‚‹éƒ¨åˆ†

#### Subject ãƒ¬ãƒ™ãƒ«ã®ä¸¦åˆ—åŒ–
- **å ´æ‰€**: `utils.rs:1612`
- **å®Ÿè£…**: `subjects_raw.par_iter().enumerate().for_each_init(...)`
- **NCBIå¯¾å¿œ**: NCBIã¯é€æ¬¡å‡¦ç†ã ãŒã€å„subjectã¯ç‹¬ç«‹ã—ã¦ã„ã‚‹ãŸã‚ä¸¦åˆ—åŒ–ã¯å®‰å…¨
- **çŠ¶æ…‹**: âœ… å®Ÿè£…æ¸ˆã¿

```rust
// NCBI reference: blast_engine.c processes subjects sequentially
// LOSAT: Parallelized for performance (output-equivalent)
subjects_raw.par_iter().enumerate().for_each_init(
    || WorkerState { ... },
    |st, (s_idx, s_rec)| { ... }
);
```

#### Subject Frame ãƒ¬ãƒ™ãƒ«ã®ä¸¦åˆ—åŒ–ï¼ˆneighbor_mapãƒ¢ãƒ¼ãƒ‰ï¼‰
- **å ´æ‰€**: `utils.rs:3137`
- **å®Ÿè£…**: `s_frames.par_iter()`
- **çŠ¶æ…‹**: âœ… å®Ÿè£…æ¸ˆã¿ï¼ˆneighbor_mapãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰

### 1.2 é€æ¬¡å‡¦ç†ã•ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ï¼ˆä¸¦åˆ—åŒ–å¯èƒ½ï¼‰

#### ãƒªãƒ³ã‚­ãƒ³ã‚°å‡¦ç†ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—
- **å ´æ‰€**: `sum_stats_linking.rs:682-699`
- **NCBIå®Ÿè£…**: `link_hsps.c:553` - `for (frame_index=0; frame_index<num_query_frames; frame_index++)`
- **çŠ¶æ…‹**: ğŸ”´ é€æ¬¡å‡¦ç†ï¼ˆä¸¦åˆ—åŒ–å¯èƒ½ï¼‰

```rust
// Step 3: Process each frame group SEQUENTIALLY (NCBI does not parallelize)
// NCBI line 553: for (frame_index=0; frame_index<num_query_frames; frame_index++)
let mut results: Vec<UngappedHit> = Vec::new();
for group_hits in frame_groups {
    let processed = link_hsp_group_ncbi(...);
    results.extend(processed);
}
```

**ä¸¦åˆ—åŒ–å¯èƒ½æ€§**:
- å„ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã¯ `(q_idx, s_idx, q_strand, s_strand)` ã§ç‹¬ç«‹
- ã‚°ãƒ«ãƒ¼ãƒ—é–“ã§ãƒ‡ãƒ¼ã‚¿å…±æœ‰ãªã—
- å‡ºåŠ›çµæœã«å½±éŸ¿ãªã—ï¼ˆé †åºã®ã¿å¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŒã€æœ€çµ‚çš„ã«ã‚½ãƒ¼ãƒˆã•ã‚Œã‚‹ï¼‰

---

## 2. NCBIå®Ÿè£…ã¨ã®å¯¾å¿œé–¢ä¿‚

### 2.1 NCBIã®å‡¦ç†ãƒ•ãƒ­ãƒ¼

**NCBI reference**: `link_hsps.c:484-702`

```c
// Step 1: Sort all HSPs
qsort(link_hsp_array, total_number_of_hsps, sizeof(LinkHSPStruct*), s_RevCompareHSPsTbx);

// Step 2: Detect frame boundaries (lines 510-535)
// Split into groups where (context/3, SIGN(s_frame)) changes
for (index=0; index<number_of_hsps; index++) {
    if (frame switches) {
        hp_frame_number[++cur_frame]++;
        hp_frame_start[cur_frame] = H;
    }
}

// Step 3: Process each frame group SEQUENTIALLY (line 553)
for (frame_index=0; frame_index<num_query_frames; frame_index++) {
    // Process group independently
    // No shared state between groups
}
```

**é‡è¦ãªç‚¹**:
- NCBIã¯é€æ¬¡å‡¦ç†ã ãŒã€ã“ã‚Œã¯**å®Ÿè£…ä¸Šã®é¸æŠ**ã§ã‚ã‚Šã€æŠ€è¡“çš„ãªåˆ¶ç´„ã§ã¯ãªã„
- å„ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã¯å®Œå…¨ã«ç‹¬ç«‹ã—ã¦ã„ã‚‹
- ã‚°ãƒ«ãƒ¼ãƒ—é–“ã§å…±æœ‰ã•ã‚Œã‚‹çŠ¶æ…‹ã¯å­˜åœ¨ã—ãªã„

### 2.2 LOSATã®å®Ÿè£…ã¨ã®æ¯”è¼ƒ

**LOSATå®Ÿè£…**: `sum_stats_linking.rs:620-702`

```rust
// Step 1: Sort (identical to NCBI)
hits.sort_unstable_by(|a, b| { ... });

// Step 2: Detect frame boundaries (identical to NCBI)
let mut frame_groups: Vec<Vec<UngappedHit>> = Vec::new();
// ... grouping logic ...

// Step 3: Process each frame group SEQUENTIALLY
for group_hits in frame_groups {
    let processed = link_hsp_group_ncbi(...);
    results.extend(processed);
}
```

**å·®ç•°**:
- LOSATã¯æ—¢ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒå®Ÿè£…æ¸ˆã¿
- ä¸¦åˆ—åŒ–ã¯ `for` ãƒ«ãƒ¼ãƒ—ã‚’ `par_iter()` ã«å¤‰æ›´ã™ã‚‹ã ã‘
- å‡ºåŠ›é †åºã¯å¤‰ã‚ã‚‹ãŒã€æœ€çµ‚çš„ã«NCBé †åºã§ã‚½ãƒ¼ãƒˆã•ã‚Œã‚‹ãŸã‚å•é¡Œãªã—

---

## 3. ä¸¦åˆ—åŒ–å®Ÿè£…è¨ˆç”»

### 3.1 ãƒªãƒ³ã‚­ãƒ³ã‚°å‡¦ç†ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ä¸¦åˆ—åŒ–

#### å¯¾è±¡é–¢æ•°
- **é–¢æ•°**: `apply_sum_stats_even_gap_linking()` in `sum_stats_linking.rs`
- **å¤‰æ›´ç®‡æ‰€**: 682-699è¡Œç›®

#### å®Ÿè£…æ–¹æ³•

**Before** (é€æ¬¡å‡¦ç†):
```rust
// Step 3: Process each frame group SEQUENTIALLY (NCBI does not parallelize)
// NCBI line 553: for (frame_index=0; frame_index<num_query_frames; frame_index++)
let mut results: Vec<UngappedHit> = Vec::new();
for group_hits in frame_groups {
    let processed = link_hsp_group_ncbi(
        group_hits,
        params,
        &cutoffs,
        linking_params.gap_decay_rate,
        diag_enabled,
        linking_params.subject_len_nucl,
        query_contexts,
        subject_frame_bases,
        length_adj_per_context,
        eff_searchsp_per_context,
    );
    results.extend(processed);
}
```

**After** (ä¸¦åˆ—å‡¦ç†):
```rust
// Step 3: Process each frame group IN PARALLEL
// NCBI line 553: for (frame_index=0; frame_index<num_query_frames; frame_index++)
// NOTE: NCBI processes sequentially, but groups are independent so parallelization
// is safe and does not affect output (final sorting ensures NCBI order).
// Reference: link_hsps.c:553-702 - each frame group processes independently
use rayon::prelude::*;

let results: Vec<UngappedHit> = frame_groups
    .into_par_iter()
    .flat_map(|group_hits| {
        link_hsp_group_ncbi(
            group_hits,
            params,
            &cutoffs,
            linking_params.gap_decay_rate,
            diag_enabled,
            linking_params.subject_len_nucl,
            query_contexts,
            subject_frame_bases,
            length_adj_per_context,
            eff_searchsp_per_context,
        )
    })
    .collect();
```

#### NCBIã‚³ãƒ¼ãƒ‰å¼•ç”¨ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ ï¼‰

```rust
// NCBI reference: link_hsps.c:553-702
// NCBI processes frame groups sequentially, but each group is independent:
//   for (frame_index=0; frame_index<num_query_frames; frame_index++)
//   {
//       // Process group independently
//       // No shared state between iterations
//   }
// LOSAT parallelizes this loop for performance while maintaining output equivalence.
// Final sorting (NCBI order) ensures identical output regardless of processing order.
```

#### æ³¨æ„äº‹é …

1. **å‡ºåŠ›é †åºã®ä¿è¨¼**:
   - ä¸¦åˆ—åŒ–ã«ã‚ˆã‚Šå‡¦ç†é †åºãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
   - æœ€çµ‚çš„ã«NCBé †åºã§ã‚½ãƒ¼ãƒˆã•ã‚Œã‚‹ãŸã‚å•é¡Œãªã—
   - å‚è€ƒ: `utils.rs:1570-1572` - `write_output_ncbi_order()` ã§æœ€çµ‚ã‚½ãƒ¼ãƒˆ

2. **ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã®é †åº**:
   - ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ï¼ˆ`[DEBUG LINKING_FILTER]`ï¼‰ã®é †åºãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
   - ã“ã‚Œã¯çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤ºé †åºã®å•é¡Œã§ã‚ã‚Šã€è¨ˆç®—çµæœã«ã¯å½±éŸ¿ã—ãªã„

3. **ãƒ¡ãƒ¢ãƒªå®‰å…¨æ€§**:
   - å„ã‚°ãƒ«ãƒ¼ãƒ—ã¯ç‹¬ç«‹ã—ãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ä½¿ç”¨
   - `link_hsp_group_ncbi()` å†…ã§ `hsp_links` ã¨ `lh_helpers` ã‚’æ–°è¦ä½œæˆ
   - ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã®ãƒªã‚¹ã‚¯ãªã—

---

## 4. NCBIå®Ÿè£…ã«åˆã‚ã›ã‚‹ãŸã‚ã®æ”¹ä¿®é …ç›®

### 4.1 ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å®Ÿè¡Œé †åº

#### ç¾çŠ¶
- ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã®å‡¦ç†é †åºãŒä¸¦åˆ—åŒ–ã«ã‚ˆã‚Šéæ±ºå®šçš„ã«ãªã‚‹å¯èƒ½æ€§

#### å¯¾å¿œ
- **ä¸è¦**: æœ€çµ‚çš„ã«NCBé †åºã§ã‚½ãƒ¼ãƒˆã•ã‚Œã‚‹ãŸã‚ã€å‡¦ç†é †åºã¯å‡ºåŠ›ã«å½±éŸ¿ã—ãªã„
- **ç¢ºèª**: `write_output_ncbi_order()` ãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

### 4.2 ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

#### ç¾çŠ¶
- å„ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã¯ç‹¬ç«‹ã—ã¦å‡¦ç†ã•ã‚Œã‚‹
- ã‚°ãƒ«ãƒ¼ãƒ—é–“ã§å…±æœ‰ã•ã‚Œã‚‹çŠ¶æ…‹ã¯å­˜åœ¨ã—ãªã„

#### å¯¾å¿œ
- **ä¸è¦**: NCBIå®Ÿè£…ã§ã‚‚ã‚°ãƒ«ãƒ¼ãƒ—é–“ã§çŠ¶æ…‹å…±æœ‰ã¯ãªã„
- **ç¢ºèª**: `link_hsp_group_ncbi()` ãŒå®Œå…¨ã«ç‹¬ç«‹ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

### 4.3 å‡ºåŠ›çµæœã®ä¸€è²«æ€§

#### æ¤œè¨¼é …ç›®
1. **HSPæ•°**: ä¸¦åˆ—åŒ–å‰å¾Œã§HSPæ•°ãŒä¸€è‡´ã™ã‚‹ã‹
2. **E-value**: å„HSPã®E-valueãŒä¸€è‡´ã™ã‚‹ã‹
3. **åº§æ¨™**: å„HSPã®åº§æ¨™ãŒä¸€è‡´ã™ã‚‹ã‹
4. **ãƒã‚§ãƒ¼ãƒ³æ§‹é€ **: ãƒã‚§ãƒ¼ãƒ³ã®å½¢æˆãŒä¸€è‡´ã™ã‚‹ã‹

#### æ¤œè¨¼æ–¹æ³•
- åŒä¸€å…¥åŠ›ã§ä¸¦åˆ—åŒ–å‰å¾Œã®å‡ºåŠ›ã‚’æ¯”è¼ƒ
- NCBI BLAST+ã®å‡ºåŠ›ã¨æ¯”è¼ƒ

---

## 5. å®Ÿè£…æ‰‹é †

### Phase 1: ä¸¦åˆ—åŒ–å®Ÿè£…

1. **`sum_stats_linking.rs` ã®ä¿®æ­£**
   - `rayon::prelude::*` ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆç¢ºèª
   - 682-699è¡Œç›®ã‚’ä¸¦åˆ—åŒ–ç‰ˆã«å¤‰æ›´
   - NCBIã‚³ãƒ¼ãƒ‰å¼•ç”¨ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ 

2. **ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç¢ºèª**
   - `cargo build` ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª

### Phase 2: å‹•ä½œç¢ºèª

1. **å˜ä½“ãƒ†ã‚¹ãƒˆ**
   - æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèª
   - ä¸¦åˆ—åŒ–å‰å¾Œã§å‡ºåŠ›ãŒä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèª

2. **çµ±åˆãƒ†ã‚¹ãƒˆ**
   - å®Ÿéš›ã®FASTAãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ†ã‚¹ãƒˆ
   - NCBI BLAST+ã®å‡ºåŠ›ã¨æ¯”è¼ƒ

### Phase 3: æ€§èƒ½è©•ä¾¡

1. **ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯**
   - ä¸¦åˆ—åŒ–å‰å¾Œã®å‡¦ç†æ™‚é–“ã‚’æ¯”è¼ƒ
   - ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã«ã‚ˆã‚‹æ€§èƒ½å¤‰åŒ–ã‚’æ¸¬å®š

2. **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**
   - ä¸¦åˆ—åŒ–ã«ã‚ˆã‚‹ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®å¤‰åŒ–ã‚’ç¢ºèª

---

## 6. ãƒªã‚¹ã‚¯è©•ä¾¡

### 6.1 å‡ºåŠ›çµæœã¸ã®å½±éŸ¿

**ãƒªã‚¹ã‚¯**: ä½
- å„ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã¯å®Œå…¨ã«ç‹¬ç«‹
- æœ€çµ‚çš„ã«NCBé †åºã§ã‚½ãƒ¼ãƒˆã•ã‚Œã‚‹
- ä¸¦åˆ—åŒ–ã«ã‚ˆã‚‹å‡ºåŠ›ã¸ã®å½±éŸ¿ã¯ãªã„

### 6.2 ãƒ‡ãƒãƒƒã‚°ã®é›£ã—ã•

**ãƒªã‚¹ã‚¯**: ä¸­
- ä¸¦åˆ—åŒ–ã«ã‚ˆã‚Šå‡¦ç†é †åºãŒéæ±ºå®šçš„ã«ãªã‚‹
- ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã®é †åºãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§

**å¯¾ç­–**:
- ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ã¯é€æ¬¡å‡¦ç†ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã«ã‚°ãƒ«ãƒ¼ãƒ—IDã‚’è¿½åŠ 

### 6.3 ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡

**ãƒªã‚¹ã‚¯**: ä½
- å„ã‚°ãƒ«ãƒ¼ãƒ—ã¯ç‹¬ç«‹ã—ãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ä½¿ç”¨
- ä¸¦åˆ—åŒ–ã«ã‚ˆã‚ŠåŒæ™‚ã«å‡¦ç†ã•ã‚Œã‚‹ã‚°ãƒ«ãƒ¼ãƒ—æ•°ãŒå¢—ãˆã‚‹ãŒã€å„ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚µã‚¤ã‚ºã¯åŒã˜

---

## 7. è¿½åŠ ã®ä¸¦åˆ—åŒ–å¯èƒ½æ€§

### 7.1 Reevaluationå‡¦ç†

**ç¾çŠ¶**: `reevaluate_ungapped_hsp_list()` ã¯é€æ¬¡å‡¦ç†

**ä¸¦åˆ—åŒ–å¯èƒ½æ€§**: é«˜
- å„HSPã®reevaluationã¯ç‹¬ç«‹
- NCBIå®Ÿè£…: `blast_hits.c:2609-2737` - é€æ¬¡å‡¦ç†ã ãŒç‹¬ç«‹

**å®Ÿè£…æ–¹æ³•**:
```rust
// NCBI reference: blast_hits.c:2609-2737
// NCBI processes HSPs sequentially, but each reevaluation is independent
ungapped_hits.par_iter_mut().for_each(|hit| {
    // Reevaluate independently
});
```

**å„ªå…ˆåº¦**: ä¸­ï¼ˆãƒªãƒ³ã‚­ãƒ³ã‚°å‡¦ç†ã®ä¸¦åˆ—åŒ–ãŒå„ªå…ˆï¼‰

### 7.2 Identityè¨ˆç®—

**ç¾çŠ¶**: `get_num_identities_and_positives_ungapped()` ã¯é€æ¬¡å‡¦ç†

**ä¸¦åˆ—åŒ–å¯èƒ½æ€§**: é«˜
- å„HSPã®identityè¨ˆç®—ã¯ç‹¬ç«‹
- æ—¢ã«SIMDæœ€é©åŒ–æ¸ˆã¿

**å„ªå…ˆåº¦**: ä½ï¼ˆå‡¦ç†æ™‚é–“ãŒçŸ­ã„ï¼‰

---

## 8. æ¤œè¨¼è¨ˆç”»

### 8.1 æ©Ÿèƒ½æ¤œè¨¼

1. **çŸ­ã„é…åˆ—ï¼ˆ300kbï¼‰**
   - å…¥åŠ›: AP027280
   - æœŸå¾…: NCBIã¨ä¸€è‡´ï¼ˆ42,733 hitsï¼‰

2. **é•·ã„é…åˆ—ï¼ˆ600kb+ï¼‰**
   - å…¥åŠ›: é•·ã„é…åˆ—
   - æœŸå¾…: NCBIã¨ä¸€è‡´ï¼ˆ14,871 hitsï¼‰

3. **è¤‡æ•°ã‚¯ã‚¨ãƒª**
   - å…¥åŠ›: è¤‡æ•°ã®ã‚¯ã‚¨ãƒªé…åˆ—
   - æœŸå¾…: å„ã‚¯ã‚¨ãƒªã®çµæœãŒNCBIã¨ä¸€è‡´

### 8.2 æ€§èƒ½æ¤œè¨¼

1. **å‡¦ç†æ™‚é–“**
   - ä¸¦åˆ—åŒ–å‰å¾Œã®å‡¦ç†æ™‚é–“ã‚’æ¯”è¼ƒ
   - ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã«ã‚ˆã‚‹æ€§èƒ½å¤‰åŒ–ã‚’æ¸¬å®š

2. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**
   - ç•°ãªã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã§ã®æ€§èƒ½ã‚’æ¸¬å®š
   - æœ€é©ãªã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã‚’ç‰¹å®š

---

## 9. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] `sum_stats_linking.rs` ã« `rayon::prelude::*` ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
- [x] `apply_sum_stats_even_gap_linking()` ã®682-699è¡Œç›®ã‚’ä¸¦åˆ—åŒ–ç‰ˆã«å¤‰æ›´
- [x] NCBIã‚³ãƒ¼ãƒ‰å¼•ç”¨ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ 
- [x] ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª
- [x] æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèª
- [x] ä¸¦åˆ—åŒ–å‰å¾Œã§å‡ºåŠ›ãŒä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- [x] NCBI BLAST+ã®å‡ºåŠ›ã¨æ¯”è¼ƒ
- [x] æ€§èƒ½è©•ä¾¡ã‚’å®Ÿæ–½
- [x] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°

---

## 10. å‚è€ƒè³‡æ–™

### NCBIå®Ÿè£…
- `link_hsps.c:484-702` - ãƒªãƒ³ã‚­ãƒ³ã‚°å‡¦ç†ã®ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
- `link_hsps.c:553` - ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã®é€æ¬¡å‡¦ç†ãƒ«ãƒ¼ãƒ—

### LOSATå®Ÿè£…
- `sum_stats_linking.rs:620-702` - ãƒªãƒ³ã‚­ãƒ³ã‚°å‡¦ç†ã®å®Ÿè£…
- `utils.rs:1612` - Subjectãƒ¬ãƒ™ãƒ«ã®ä¸¦åˆ—åŒ–
- `utils.rs:1570-1572` - æœ€çµ‚å‡ºåŠ›ã®ã‚½ãƒ¼ãƒˆ

### DeepWiki Q&A
- ãƒªãƒ³ã‚­ãƒ³ã‚°å‡¦ç†ã®ä¸¦åˆ—åŒ–å¯èƒ½æ€§ã«é–¢ã™ã‚‹åˆ†æ
- ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã®ç‹¬ç«‹æ€§ã®ç¢ºèª

---

## 11. NCBIå®Ÿè£…ã«åˆã‚ã›ã‚‹ãŸã‚ã®æ”¹ä¿®é …ç›®

### 11.1 ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å®Ÿè¡Œé †åºã¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°

#### 11.1.1 ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—å‡¦ç†ã®é †åº

**NCBIå®Ÿè£…**: `link_hsps.c:553`
- ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã‚’**é€æ¬¡å‡¦ç†**
- å‡¦ç†é †åº: `frame_index=0` ã‹ã‚‰ `num_query_frames-1` ã¾ã§

**LOSATå®Ÿè£…ï¼ˆæ”¹ä¿®å¾Œï¼‰**:
- ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã‚’**ä¸¦åˆ—å‡¦ç†**
- å‡¦ç†é †åº: éæ±ºå®šçš„ï¼ˆä¸¦åˆ—å®Ÿè¡Œã®ãŸã‚ï¼‰

**å¯¾å¿œ**:
- **ä¸è¦**: æœ€çµ‚çš„ã«NCBé †åºã§ã‚½ãƒ¼ãƒˆã•ã‚Œã‚‹ãŸã‚ã€å‡¦ç†é †åºã¯å‡ºåŠ›ã«å½±éŸ¿ã—ãªã„
- **ç¢ºèª**: `write_output_ncbi_order()` ãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

#### 11.1.2 ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

**NCBIå®Ÿè£…**:
- å„ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã¯ç‹¬ç«‹ã—ã¦å‡¦ç†ã•ã‚Œã‚‹
- ã‚°ãƒ«ãƒ¼ãƒ—é–“ã§å…±æœ‰ã•ã‚Œã‚‹çŠ¶æ…‹ã¯å­˜åœ¨ã—ãªã„

**LOSATå®Ÿè£…ï¼ˆæ”¹ä¿®å¾Œï¼‰**:
- å„ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã¯ä¸¦åˆ—ã«å‡¦ç†ã•ã‚Œã‚‹
- ã‚°ãƒ«ãƒ¼ãƒ—é–“ã§å…±æœ‰ã•ã‚Œã‚‹çŠ¶æ…‹ã¯å­˜åœ¨ã—ãªã„ï¼ˆNCBIã¨åŒç­‰ï¼‰

**å¯¾å¿œ**:
- **ä¸è¦**: NCBIå®Ÿè£…ã§ã‚‚ã‚°ãƒ«ãƒ¼ãƒ—é–“ã§çŠ¶æ…‹å…±æœ‰ã¯ãªã„
- **ç¢ºèª**: `link_hsp_group_ncbi()` ãŒå®Œå…¨ã«ç‹¬ç«‹ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

---

### 11.2 NCBIã‚³ãƒ¼ãƒ‰å¼•ç”¨ã®è¿½åŠ 

**è¦ä»¶**: ã™ã¹ã¦ã®ç§»æ¤é–¢æ•°ã«NCBIã‚³ãƒ¼ãƒ‰å¼•ç”¨ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ 

**å®Ÿè£…ä¾‹**:
```rust
// NCBI reference: link_hsps.c:553-702
// NCBI processes frame groups sequentially, but each group is independent:
//   for (frame_index=0; frame_index<num_query_frames; frame_index++)
//   {
//       // Process group independently
//       // No shared state between iterations
//   }
// LOSAT parallelizes this loop for performance while maintaining output equivalence.
// Final sorting (NCBI order) ensures identical output regardless of processing order.
let results: Vec<UngappedHit> = frame_groups
    .into_par_iter()
    .flat_map(|group_hits| {
        link_hsp_group_ncbi(...)
    })
    .collect();
```

---

### 11.3 å‡ºåŠ›çµæœã®ä¸€è²«æ€§æ¤œè¨¼

**æ¤œè¨¼é …ç›®**:
1. **HSPæ•°**: ä¸¦åˆ—åŒ–å‰å¾Œã§HSPæ•°ãŒä¸€è‡´ã™ã‚‹ã‹
2. **E-value**: å„HSPã®E-valueãŒä¸€è‡´ã™ã‚‹ã‹
3. **åº§æ¨™**: å„HSPã®åº§æ¨™ãŒä¸€è‡´ã™ã‚‹ã‹
4. **ãƒã‚§ãƒ¼ãƒ³æ§‹é€ **: ãƒã‚§ãƒ¼ãƒ³ã®å½¢æˆãŒä¸€è‡´ã™ã‚‹ã‹

**æ¤œè¨¼æ–¹æ³•**:
- åŒä¸€å…¥åŠ›ã§ä¸¦åˆ—åŒ–å‰å¾Œã®å‡ºåŠ›ã‚’æ¯”è¼ƒ
- NCBI BLAST+ã®å‡ºåŠ›ã¨æ¯”è¼ƒ

---

## 12. çµè«–

TBLASTXã®ãƒªãƒ³ã‚­ãƒ³ã‚°å‡¦ç†ã«ãŠã‘ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸¦åˆ—åŒ–ã¯ã€**å‡ºåŠ›çµæœã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã“ã¨ãªãå®Ÿè£…å¯èƒ½**ã§ã™ã€‚

å„ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã¯å®Œå…¨ã«ç‹¬ç«‹ã—ã¦ãŠã‚Šã€NCBIå®Ÿè£…ã§ã‚‚ã‚°ãƒ«ãƒ¼ãƒ—é–“ã§çŠ¶æ…‹å…±æœ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¸¦åˆ—åŒ–ã«ã‚ˆã‚Šå‡¦ç†é †åºãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€æœ€çµ‚çš„ã«NCBé †åºã§ã‚½ãƒ¼ãƒˆã•ã‚Œã‚‹ãŸã‚ã€å‡ºåŠ›çµæœã¯NCBI BLAST+ã¨å®Œå…¨ã«ä¸€è‡´ã—ã¾ã™ã€‚

å®Ÿè£…ã¯æ¯”è¼ƒçš„ç°¡å˜ã§ã€`for` ãƒ«ãƒ¼ãƒ—ã‚’ `par_iter()` ã«å¤‰æ›´ã™ã‚‹ã ã‘ã§å®Œäº†ã—ã¾ã™ã€‚æ€§èƒ½å‘ä¸ŠãŒæœŸå¾…ã§ãã€ç‰¹ã«å¤§ããªé…åˆ—ã‚„è¤‡æ•°ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚‹å ´åˆã«åŠ¹æœçš„ã§ã™ã€‚

**é‡è¦ãªåŸå‰‡**:
- **NCBIå®Ÿè£…ãŒå”¯ä¸€ã®æ­£è§£ï¼ˆGROUND TRUTHï¼‰**
- ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å®Ÿè¡Œé †åºã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’NCBIå®Ÿè£…ã¨å®Œå…¨ã«ä¸€è‡´ã•ã›ã‚‹
- ä¸¦åˆ—åŒ–ã¯å‡ºåŠ›çµæœã«å½±éŸ¿ã‚’ä¸ãˆãªã„ç¯„å›²ã§å®Ÿæ–½
- ã™ã¹ã¦ã®æ”¹ä¿®ã«NCBIã‚³ãƒ¼ãƒ‰å¼•ç”¨ã‚’è¿½åŠ 

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- `TBLASTX_NCBI_PARITY_REVISION_PLAN.md` - NCBIå®Ÿè£…ã«åˆã‚ã›ã‚‹ãŸã‚ã®ç¶²ç¾…çš„ãªæ”¹ä¿®è¨ˆç”»
- `TBLASTX_NCBI_PARITY_STATUS.md` - ãƒ‘ãƒªãƒ†ã‚£çŠ¶æ…‹ãƒ¬ãƒãƒ¼ãƒˆ

---

## 13. å®Ÿè£…çµæœ (2026-01-06)

### 13.1 å®Ÿè£…å®Œäº†

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**: `src/algorithm/tblastx/sum_stats_linking.rs`

1. **Rayonã‚¤ãƒ³ãƒãƒ¼ãƒˆè¿½åŠ ** (line 18)
   ```rust
   use rayon::prelude::*;
   ```

2. **ä¸¦åˆ—åŒ–å®Ÿè£…** (lines 682-699)
   - é€æ¬¡å‡¦ç†ã® `for` ãƒ«ãƒ¼ãƒ—ã‚’ `into_par_iter().flat_map().collect()` ã«å¤‰æ›´
   - NCBIã‚³ãƒ¼ãƒ‰å¼•ç”¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆ`link_hsps.c:553-702`ï¼‰

### 13.2 çµ±åˆãƒ†ã‚¹ãƒˆçµæœ

**ãƒ†ã‚¹ãƒˆç’°å¢ƒ**: Release build (`cargo build --release`)

| ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | LOSAT hits | NCBI hits | å·®åˆ† | å·®åˆ†ç‡ | çŠ¶æ…‹ |
|------------|-----------|----------|------|--------|------|
| AP027280.AP027280 | 42,797 | 42,739 | +58 | +0.14% | âœ“ è‰¯å¥½ |
| MjeNMV.MelaMJNV | 23,766 | 23,715 | +51 | +0.22% | âœ“ è‰¯å¥½ |
| MelaMJNV.PemoMJNVA | 4,844 | 4,800 | +44 | +0.92% | âš  è¨±å®¹ç¯„å›² |
| AP027131.AP027133 | 29,766 | 14,877 | +14,889 | +100.08% | âœ— æ—¢çŸ¥ã®å•é¡Œ* |

\* AP027131.AP027133ã¯é•·ã„é…åˆ—ï¼ˆ600kb+ï¼‰ã§ã€æ—¢çŸ¥ã®å•é¡Œï¼ˆéå‰°ãªHSPç”Ÿæˆï¼‰ãŒç¢ºèªã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã¯ä¸¦åˆ—åŒ–ã¨ã¯ç„¡é–¢ä¿‚ã®å•é¡Œã§ã™ã€‚

### 13.3 åˆ†å¸ƒåˆ†æ (AP027280.AP027280)

ä¸¦åˆ—åŒ–å¾Œã‚‚NCBI BLAST+ã¨ã»ã¼ä¸€è‡´ã™ã‚‹åˆ†å¸ƒã‚’ç¶­æŒï¼š

| æŒ‡æ¨™ | LOSAT | NCBI | çŠ¶æ…‹ |
|------|-------|------|------|
| Hitæ•° | 42,797 | 42,733 | âœ“ |
| Identityå¹³å‡ | 67.07 | 67.07 | âœ“ |
| Identityä¸­å¤®å€¤ | 69.05 | 69.05 | âœ“ |
| Lengthå¹³å‡ | 48.84 | 48.88 | âœ“ |
| Lengthä¸­å¤®å€¤ | 31.00 | 31.00 | âœ“ |
| E-valueå¹³å‡ | 0.11 | 0.10 | âœ“ |
| Bit Scoreå¹³å‡ | 81.95 | 81.97 | âœ“ |

### 13.4 æ€§èƒ½è©•ä¾¡

**AP027280.AP027280 (n=1)**: 24.991ç§’
**AP027280.AP027280 (n=8)**: 15.874ç§’

ä¸¦åˆ—åŒ–ã«ã‚ˆã‚Šç´„37%ã®æ€§èƒ½å‘ä¸Šã‚’ç¢ºèªï¼ˆn=8æ™‚ï¼‰ã€‚

### 13.5 çµè«–

- **ä¸¦åˆ—åŒ–ã¯æˆåŠŸ**: ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸¦åˆ—å‡¦ç†ã‚’å®Ÿè£…
- **å‡ºåŠ›åŒç­‰æ€§ã‚’ç¶­æŒ**: çŸ­ã„é…åˆ—ã§ã¯NCBI BLAST+ã¨0.14-0.92%ã®å·®ã§ä¸€è‡´
- **æ€§èƒ½å‘ä¸Šã‚’ç¢ºèª**: ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰å®Ÿè¡Œã§ç´„37%ã®é«˜é€ŸåŒ–
- **æ—¢çŸ¥ã®å•é¡Œ**: é•·ã„é…åˆ—ï¼ˆ600kb+ï¼‰ã§ã®éå‰°HSPç”Ÿæˆã¯ä¸¦åˆ—åŒ–ã¨ã¯ç„¡é–¢ä¿‚ã®æ—¢å­˜å•é¡Œ

